#!/bin/sh
set -eu

usage() {
    echo "Usage: $0 [-ag]"
    exit 1
}

all=
git=
while getopts 'ag' o; do
    case "$o" in
        a)
            all=true
            ;;
        g)
            git=true
            ;;
        *)
            usage
            ;;
    esac
done

if command -v yay > /dev/null; then
    if [ -n "$git" ]; then
        yay -Syu --devel --needed
    else
        yay -Syu
    fi
else
    echo "yay not found, using pacman..."
    sudo pacman -Syu
fi

if command -v flatpak > /dev/null; then
    echo "updating global flatpak applications..."
    sudo flatpak update -y
    echo "updating user flatpak applications..."
    flatpak update --user -y
else
    echo "flatpak not found, skipping..."
fi

if [ -n "$all" ]; then
    if command -v cargo > /dev/null; then
        echo 'updating cargo crates...'
        if [ -n "$git" ]; then
            cargo install-update --all --git
        else
            cargo install-update --all
        fi
    else
        echo 'cargo not found, skipping...'
    fi

    if command -v rustup > /dev/null; then
        echo 'updating rustup toolchains...'
        rustup update
    else
        echo 'rustup not found, skipping...'
    fi

    # TODO: Fix this
    # if command -v pip > /dev/null; then
    #     echo 'updating user-local pip packages...'
    #     pip list --user --outdated --format=freeze | grep -v '^\-e' | cut -d = -f 1 | xargs -r pip install --user -U --upgrade-strategy eager
    #     echo 'updating globally installed pip packages...'
    #     pip list --outdated --format=freeze | grep -v '^\-e' | cut -d = -f 1 | xargs -r -n1 sudo pip install -U --upgrade-strategy eager
    # else
    #     echo 'pip not found, skipping...'
    # fi

    if command -v npm > /dev/null; then
        echo 'updating npm packages...'
        npm -g outdated --parseable --depth=0 | cut -d: -f2 | xargs -r -n1 sudo npm -g install
    else
        echo 'npm not found, skipping...'
    fi
fi
